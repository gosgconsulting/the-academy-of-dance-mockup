class PgTailwindCompilerV4{static compiler_instance;static getInstance=function(e){return PgTailwindCompilerV4.compiler_instance||(e=e||pinegrow.findFrameworkByType("tailwind"),PgTailwindCompilerV4.compiler_instance=new PgTailwindCompilerV4(e)),PgTailwindCompilerV4.compiler_instance};constructor(e){const i=this;this.f=e,this.run_list=[],this.$iframe=$(`<iframe style="position:absolute;width:200px;height:200px;bottom:-1000px;left:-300px;"></iframe>`),$("body").append(this.$iframe),this.$iframe.on("load",function(){var e=i.run_list;i.run_list=null,e&&e.forEach(function(e){e()})}),this.$iframe.get(0).srcdoc=this.getIframeHTML(),this.full=!0,this.handlers=[],this.handlers_error=[],this.is_busy=!1,window.addEventListener("message",t=>{"tailwindCompileDoneV4"===t.data.command&&(i.is_busy=!1,i.handlers.forEach(function(e){e(t)}),i.handlers=[],i.handlers_error=[],i.onmessage(t))})}addHandlers(e,t){this.handlers.push(e),this.handlers_error.push(t)}removeHandlers(e,t){var i=this.handlers.indexOf(e);0<=i&&this.handlers.splice(i,1),0<=(i=this.handlers_error.indexOf(t))&&this.handlers_error.splice(i,1)}getIframeHTML(){return`<!DOCTYPE html> 
<html lang="en"> 
    <head> 
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> 
        <title>New page</title>         
        <script src="${this.f.getResourceUrl("resources/tailwind.compiler.v4.js")}"></script>         
        <style id="theme" type="text/tailwindcss">
        </style>
        <script src="${this.f.getResourceUrl("resources/tailwind.compiler.phone.v4.js")}"></script>   
    </head>     
    <body> 
    </body>     
</html>
`}postMessage(e,t,i){const s=this;var r,n;null!==this.run_list?this.run_list.push(function(){s.postMessage(e,t,i)}):(t&&this.addHandlers(t,i),r=e.css,this.is_busy||(this.is_busy=!0,n=e.html[0].replace("<html><body","<div").replace("</body></html>","</div>"),this.$iframe.get(0).contentWindow.postMessage({command:"compile",theme:r,content:n},"*")))}onerror(e){}onmessage(e){}}class PgTailwindConfigReaderV4{constructor(){}async getCSSFromExternalConfig(e,t){const r=require("path"),n=require("fs").promises,o=r.join(e,"node_modules/tailwindcss");var i=r.join(o,"dist/lib.js"),i=require(i);let s=await n.readFile(t,{encoding:"utf8"});var a=s.split("\n");for(let c=0;c<a.length;c++){var l=a[c];l&&(l.match(/@import\s+['"]tailwindcss['"]/)||l.match(/@import\s+['"]tailwindcss\/theme['"]/)?l.match(/theme\(\s*static/)||(a[c]=l.replace(";"," theme(static);")):l.match(/@theme /)&&!l.match(/ static/)&&(a[c]=l.replace("@theme","@theme static")))}return s=a.join("\n"),(await i.compile(s,{base:"/",loadStylesheet:async function(e,t){console.log("loadStylesheet",e,t);var i={tailwindcss:"index.css",preflight:"preflight.css",theme:"theme.css",utilities:"utilities.css"};let s="";return{base:t,content:s=i[e]?await n.readFile(r.join(o,i[e]),{encoding:"utf8"}):s}},loadModule:async function(e,t){function i(e=0){return{handler({}){}}}return i.__isOptionsFunction=!0,{base:t,module:i}}})).build(["text-base"])}async getCSSFromInternalCompiler(){return new Promise(function(t,i){PgTailwindCompilerV4.getInstance().postMessage({css:`@import "tailwindcss" theme(static);

@plugin "@tailwindcss/typography";
@plugin "@tailwindcss/forms";`,html:[`<html><body class="text-base"></body></html>`],config:{}},function(e){e.data.error?i(e.data.error):t(e.data.css)},function(e){i(e)})})}async getCSSFromDesignPanel(e){var t,i;if(e.useExternalBuild())return t=pinegrow.getCurrentProject(),i=crsaMakeFileFromUrl(t.getAbsoluteUrl(e.settings.external_source_url)),this.getCSSFromExternalConfig(t.getDir(),i);{const r=await e.withEngine();return new Promise(function(i,s){r.updateTask(function(e,t){t?s(t):i(e)})})}}async getConfig(e,t){let i;var s;i=t?await this.getCSSFromExternalConfig(e,t):pgDmStore.isDesignEnabled(PgDmDesignProviderForTailwind)?(s=pgDmStore.getActiveDesignProvider(),await this.getCSSFromDesignPanel(s)):await this.getCSSFromInternalCompiler(null);const a={color:{}},l={ease:!0};return i.replace(/(?<!var\(\s*)(--[^:]+):\s?([^;]*);/gm,function(e,t,i){var s,r,n=(t=t.replace("--","")).split("-"),o=n.shift();return l[o]?(a[o]||(a[o]={}),a[o][n.join("-")]=i):0===n.length?a[o]=i:"color"===o?(s=n.shift(),n.length?(r=n.join("-"),a.color[s]||(a.color[s]={}),"string"==typeof a.color[s]&&(a.color[s]={noshade:a.color[s]}),a.color[s][r]=i):"object"==typeof a.color[s]?a.color[s].noshade=i:a.color[s]=i):1===n.length?(a[o]||(a[o]={}),a[o][n[0]]=i):(r=n.pop(),o=o+"-"+n.join("-"),a[o]||(a[o]={}),a[o][r]=i),""}),a}}